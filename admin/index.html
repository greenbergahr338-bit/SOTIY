<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Админ · СОТЫЙ</title>
<style>
:root{--bg:#0f172a;--panel:#0b1220;--muted:#94a3b8;--line:#1f2937;--primary:#2563eb;--accent:#38bdf8;--ok:#10b981;--bad:#ef4444;--text:#fff}
*{box-sizing:border-box}html{scroll-behavior:smooth}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial}
.container{max-width:800px;margin:0 auto;padding:20px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:20px}
h1{margin:0 0 12px;font-size:26px}
label{display:block;margin:10px 0 6px;color:#cbd5e1}
input[type="number"],input[type="password"]{
  width:100%;padding:12px 14px;border-radius:12px;border:1px solid #1f2937;background:#0a1020;color:#fff;outline:none
}
input[type="number"]:focus,input[type="password"]:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(56,189,248,.18)}
.row{display:flex;gap:12px;flex-wrap:wrap}
.row .col{flex:1 1 220px}
.btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:12px;padding:.7rem 1rem;font-weight:700;cursor:pointer;border:0;color:#fff;background:var(--primary)}
.btn:hover{filter:brightness(1.08)} .btn.secondary{background:rgba(255,255,255,.06);color:#e5e7eb;border:1px solid rgba(255,255,255,.12)}
.small{color:#9aa3b2;font-size:.9rem}
.toast{position:fixed;right:16px;bottom:16px;background:#0b1220;border:1px solid var(--line);padding:12px 14px;border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.2);display:none}
hr{border:0;border-top:1px solid var(--line);margin:14px 0}
.badge{display:inline-block;padding:.25rem .5rem;border:1px solid rgba(255,255,255,.12);border-radius:.5rem;background:rgba(255,255,255,.06);color:#cbd5e1;font-size:.8rem}
header{position:sticky;top:0;background:rgba(0,0,0,.5);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
.header-row{display:flex;justify-content:space-between;align-items:center;padding:10px 16px}
a{color:#fff;text-decoration:none}
</style>
</head>
<body>
<header>
  <div class="header-row container">
    <div style="display:flex;align-items:center;gap:10px">
      <strong>Админ-панель</strong><span class="badge">/admin</span>
    </div>
    <a href="/" class="small">← На сайт</a>
  </div>
</header>

<main class="container">
  <div class="card" id="authCard">
    <h1>Вход</h1>
    <p class="small">Введите пароль администратора, чтобы управлять прогрессом «Путь к миллиону».</p>
    <label>Пароль</label>
    <input type="password" id="pwd" placeholder="••••••••••" autocomplete="current-password" />
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="loginBtn">Войти</button>
      <button class="btn secondary" id="setPinBtn" title="Сменить PIN, если хотите">Сменить локальный PIN</button>
    </div>
    <p class="small" style="margin-top:8px">По умолчанию используется локальный PIN в вашем браузере. Если ранее вы не задавали свой PIN, попробуйте: <b>0000</b>.</p>
  </div>

  <div class="card" id="formCard" style="display:none">
    <h1>Путь к 1 000 000 ₽ — обновление прогресса</h1>
    <div class="row">
      <div class="col">
        <label>Текущий баланс, ₽</label>
        <input type="number" id="current" min="0" step="1" placeholder="Напр. 25000" />
      </div>
      <div class="col">
        <label>Цель, ₽</label>
        <input type="number" id="goal" min="1" step="1" placeholder="1000000" />
      </div>
    </div>
    <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="saveBtn">Сохранить</button>
      <button class="btn secondary" id="exportBtn">Экспортировать progress.json</button>
      <button class="btn secondary" id="logoutBtn">Выйти</button>
    </div>
    <hr />
    <div class="small">Подсказка: Главная страница автоматически читает данные из <b>localStorage</b> (ключ <code>progress</code>) или из файла <code>/progress.json</code>. После сохранения обновите главную.</div>
  </div>

  <div class="card" style="margin-top:16px">
    <h2 style="margin:0 0 8px;font-size:20px">Публикация для всех (GitHub)</h2>
    <p class="small">Чтобы обновление видели все посетители, можно автоматически заливать <code>progress.json</code> в репозиторий. Нужен персональный токен GitHub с правом <b>contents:write</b>. Токен хранится локально в вашем браузере (в <code>localStorage</code>).</p>
    <div class="row">
      <div class="col">
        <label>GitHub Token</label>
        <input type="password" id="ghToken" placeholder="ghp_xxx..." />
      </div>
      <div class="col">
        <label>Репозиторий (owner/name)</label>
        <input type="text" id="ghRepo" placeholder="greenbergahr338-bit/SOTIY" />
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>Ветка</label>
        <input type="text" id="ghBranch" placeholder="main" />
      </div>
      <div class="col">
        <label>Путь файла</label>
        <input type="text" id="ghPath" placeholder="progress.json" />
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="btnSaveGh">Залить в GitHub</button>
      <button class="btn secondary" id="btnSaveGhCfg">Сохранить настройки</button>
      <button class="btn secondary" id="btnClearGhCfg">Сбросить</button>
    </div>
    <p class="small" style="margin-top:8px">⚠️ Безопасность: токен хранится только в вашем браузере; админка статична и никуда его не отправляет, кроме вызова GitHub API при вашей кнопке.</p>
  </div>

</main>

<div class="toast" id="toast"></div>

<script>
// --- Simple local PIN auth (client-side only) ---
// This is not secure for sensitive data; for static hosting it's a light gate.
const LS_PIN_KEY = 'sotiy_admin_pin';
const DEFAULT_PIN = '0000';

function getPin(){ return localStorage.getItem(LS_PIN_KEY) || DEFAULT_PIN; }
function setPin(newPin){ localStorage.setItem(LS_PIN_KEY, String(newPin||'').trim()); }

const authCard = document.getElementById('authCard');
const formCard = document.getElementById('formCard');
const loginBtn = document.getElementById('loginBtn');
const setPinBtn = document.getElementById('setPinBtn');
const pwdInput = document.getElementById('pwd');

function showToast(msg){
  const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block';
  setTimeout(()=>{t.style.display='none'}, 2200);
}

loginBtn.addEventListener('click', ()=>{
  const ok = (pwdInput.value||'').trim() === getPin();
  if(ok){ authCard.style.display='none'; formCard.style.display='block'; loadProgress(); showToast('Вход выполнен'); }
  else{ showToast('Неверный пароль'); }
});

setPinBtn.addEventListener('click', ()=>{
  const cur = prompt('Текущий PIN:', '');
  if(cur===null) return;
  if(cur.trim() !== getPin()){ showToast('Неверный текущий PIN'); return; }
  const next = prompt('Новый PIN (4-12 цифр/символов):', '');
  if(next===null) return;
  if((next.trim()).length < 4){ showToast('Слишком короткий PIN'); return; }
  setPin(next.trim());
  showToast('PIN обновлён');
});

// --- Progress form logic ---
const currentEl = document.getElementById('current');
const goalEl = document.getElementById('goal');
const saveBtn = document.getElementById('saveBtn');
const exportBtn = document.getElementById('exportBtn');
const logoutBtn = document.getElementById('logoutBtn');

function loadProgress(){
  let current = 0, goal = 1000000;
  try{
    const ls = localStorage.getItem('progress');
    if(ls){
      const d = JSON.parse(ls);
      if(+d.current>=0) current = +d.current;
      if(+d.goal>0) goal = +d.goal;
    }
  }catch(_){}
  currentEl.value = current;
  goalEl.value = goal;
}

function saveProgress(){
  const current = Math.max(0, Math.floor(+currentEl.value||0));
  const goal = Math.max(1, Math.floor(+goalEl.value||1));
  const data = { current, goal, updatedAt: new Date().toISOString() };
  localStorage.setItem('progress', JSON.stringify(data));
  showToast('Сохранено');
}

saveBtn.addEventListener('click', saveProgress);
logoutBtn.addEventListener('click', ()=>{ formCard.style.display='none'; authCard.style.display='block'; pwdInput.value=''; });

// Export /progress.json so you can upload it to the repo root if you prefer file-based updates
exportBtn.addEventListener('click', ()=>{
  const current = Math.max(0, Math.floor(+currentEl.value||0));
  const goal = Math.max(1, Math.floor(+goalEl.value||1));
  const data = { current, goal, updatedAt: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'progress.json';
  a.click();
  URL.revokeObjectURL(a.href);
  showToast('Файл progress.json выгружен');
});

// Auto-focus password input
pwdInput.focus();

// --- GitHub upload (optional) ---
const ghTokenEl = document.getElementById('ghToken');
const ghRepoEl = document.getElementById('ghRepo');
const ghBranchEl = document.getElementById('ghBranch');
const ghPathEl = document.getElementById('ghPath');
const btnSaveGh = document.getElementById('btnSaveGh');
const btnSaveGhCfg = document.getElementById('btnSaveGhCfg');
const btnClearGhCfg = document.getElementById('btnClearGhCfg');

const GH_CFG_KEY = 'sotiy_admin_github_cfg';

function loadGhCfg(){
  try{
    const cfg = JSON.parse(localStorage.getItem(GH_CFG_KEY) || '{}');
    ghTokenEl.value = cfg.token || '';
    ghRepoEl.value = cfg.repo || '';
    ghBranchEl.value = cfg.branch || 'main';
    ghPathEl.value = cfg.path || 'progress.json';
  }catch(_){}
}
function saveGhCfg(){
  const cfg = {
    token: ghTokenEl.value.trim(),
    repo: ghRepoEl.value.trim(),
    branch: ghBranchEl.value.trim() || 'main',
    path: ghPathEl.value.trim() || 'progress.json'
  };
  localStorage.setItem(GH_CFG_KEY, JSON.stringify(cfg));
  showToast('Настройки сохранены');
}
function clearGhCfg(){
  localStorage.removeItem(GH_CFG_KEY);
  ghTokenEl.value = ghRepoEl.value = ghBranchEl.value = ghPathEl.value = '';
  showToast('Настройки сброшены');
}
async function uploadProgressToGitHub(){
  const cfg = JSON.parse(localStorage.getItem(GH_CFG_KEY) || '{}');
  const token = (ghTokenEl.value || cfg.token || '').trim();
  const repo = (ghRepoEl.value || cfg.repo || '').trim();
  const branch = (ghBranchEl.value || cfg.branch || 'main').trim();
  const path = (ghPathEl.value || cfg.path || 'progress.json').trim();
  if(!token || !repo){ showToast('Укажи токен и репозиторий'); return; }

  const current = Math.max(0, Math.floor(+currentEl.value||0));
  const goal = Math.max(1, Math.floor(+goalEl.value||1));
  const data = { current, goal, updatedAt: new Date().toISOString() };
  const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));

  const apiBase = 'https://api.github.com';
  const [owner, name] = repo.split('/');

  // get sha if file exists
  let sha = null;
  try{
    const r0 = await fetch(`${apiBase}/repos/${owner}/${name}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`);
    if(r0.ok){
      const j = await r0.json();
      sha = j.sha || null;
    }
  }catch(_){}

  // put file
  const body = {
    message: `chore(progress): update ${path}`,
    content,
    branch
  };
  if(sha) body.sha = sha;

  const r = await fetch(`${apiBase}/repos/${owner}/${name}/contents/${encodeURIComponent(path)}`, {
    method: 'PUT',
    headers: { 'Authorization': `token ${token}`, 'Accept':'application/vnd.github+json' },
    body: JSON.stringify(body)
  });

  if(r.ok){ showToast('Залито в GitHub (ожидай деплой 1–3 мин)'); }
  else{
    const err = await r.text().catch(()=>'');
    console.error('GitHub upload error', r.status, err);
    showToast('Ошибка загрузки в GitHub');
  }
}

loadGhCfg();
btnSaveGh?.addEventListener('click', uploadProgressToGitHub);
btnSaveGhCfg?.addEventListener('click', saveGhCfg);
btnClearGhCfg?.addEventListener('click', clearGhCfg);

</script>
</body>
</html>
